<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gerenciar Produtos • Dashboard Estoque</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css">
    <link rel="stylesheet" href="https://cdn.datatables.net/buttons/2.4.1/css/buttons.dataTables.min.css">
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/buttons/2.4.1/js/dataTables.buttons.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/pdfmake.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/vfs_fonts.js"></script>
    <script src="https://cdn.datatables.net/buttons/2.4.1/js/buttons.html5.min.js"></script>
    <script src="https://cdn.datatables.net/buttons/2.4.1/js/buttons.print.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <style>
        html, body { height:100%; margin:0; font-family:'Inter',sans-serif; background:#f4f6f9; display:flex; flex-direction:column;}
        header { display:flex; flex-direction:column; align-items:center; padding:20px; background:#fff; box-shadow:0 2px 6px rgba(0,0,0,0.05);}
        header .logo img { height:50px; margin-bottom:10px;}
        .nav-links { display:flex; justify-content:center; gap:20px; font-weight:600;}
        .nav-links a { text-decoration:none; color:#4f83ff; padding:8px 16px; border-radius:8px; transition:all 0.3s ease; }
        .nav-links a:hover { background:#4f83ff; color:#fff; transform:translateY(-2px); box-shadow:0 4px 8px rgba(0,0,0,0.2);}
        main { flex:1; padding:20px; max-width:1200px; margin:auto; width:100%;}
        .container { background:#fff; padding:20px; border-radius:10px; box-shadow:0 2px 5px rgba(0,0,0,0.08);}
        h1{color:#2c3e50;margin-bottom:15px;}
        .actions{display:flex;gap:10px;flex-wrap:wrap;margin-bottom:15px;}
        input, select, button{padding:6px 10px;border:1px solid #ccc;border-radius:6px;transition:0.2s;}
        input:focus, select:focus{border-color:#4f83ff;outline:none;}
        button{background:#4f83ff;color:#fff;border:none;cursor:pointer;font-weight:600;}
        button:hover{background:#3b6be0;transform:translateY(-1px);}
        .kpis{display:flex;gap:12px;flex-wrap:wrap;margin-bottom:20px;}
        .kpi{flex:1;min-width:150px;background:#fff;padding:15px;border-radius:10px;box-shadow:0 2px 5px rgba(0,0,0,0.08);text-align:center;}
        .kpi h2{margin:5px 0;color:#4f83ff;}
        .charts{display:flex;flex-wrap:wrap;gap:12px;margin-bottom:20px;}
        .chart-card{flex:1;min-width:300px;background:#fff;padding:14px;border-radius:10px;box-shadow:0 2px 5px rgba(0,0,0,0.08);}
        .chart-title{font-weight:500;margin-bottom:6px;}
        table.dataTable{width:100%;background:#fff;border-radius:10px;overflow:hidden;margin-top:20px;}
        footer { text-align:center; padding:15px 0; background:#f1f3f6; border-top:1px solid #ddd; color:#555; font-size:14px;}
        .alert{color:#e74c3c;font-weight:600;}
    </style>
</head>
<body>
<header>
    <nav class="nav-links">
        <a href="Dashboard-relatorios-estoque.html">Dashboard</a>
        <a href="index.html">Movimentações</a>
        <a href="client-web-crud.html">Gerenciar Produtos</a>
        <a href="listagem.html">Listagem Simples</a>
    </nav>
</header>

<main>
    <div class="container">
        <h1>Dashboard • Gerenciar Produtos</h1>

        <div class="actions">
            <input id="filtroTexto" placeholder="Buscar por nome ou categoria">
            <select id="statusFiltro">
                <option value="">Todos os status</option>
                <option>Disponível</option>
                <option>Indisponível</option>
                <option>Esgotado</option>
                <option>Em Reposição</option>
                <option>Em Promoção</option>
            </select>
            <button id="btnRecarregar">Recarregar</button>
        </div>

        <div class="kpis">
            <div class="kpi"><p>Total Produtos</p><h2 id="kpiTotal">0</h2></div>
            <div class="kpi"><p>Total em Estoque</p><h2 id="kpiEstoque">0</h2></div>
            <div class="kpi"><p>Categorias</p><h2 id="kpiCategorias">0</h2></div>
            <div class="kpi"><p>Valor Total</p><h2 id="kpiValor">R$0,00</h2></div>
        </div>

        <div class="charts">
            <div class="chart-card">
                <div class="chart-title">Distribuição por categoria</div>
                <canvas id="chartCategoria" height="220"></canvas>
            </div>
            <div class="chart-card">
                <div class="chart-title">Produtos por status</div>
                <canvas id="chartStatus" height="220"></canvas>
            </div>
            <div class="chart-card">
                <div class="chart-title">Top 5 valor em estoque</div>
                <canvas id="chartTopValor" height="220"></canvas>
            </div>
        </div>

        <table id="tblProdutos" class="display nowrap" style="width:100%">
            <thead>
            <tr>
                <th>Nome</th>
                <th>Categoria</th>
                <th>Quantidade</th>
                <th>Preço</th>
                <th>Valor Total</th>
                <th>Status</th>
            </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>
</main>

<footer>
    © 2025 Sistema de Controle de Estoque • Desenvolvido por Gabriel Sbruzzi
</footer>

<script>
    const BASE_URL = 'http://localhost:8080/produtos';
    const BRL = new Intl.NumberFormat('pt-BR',{style:'currency',currency:'BRL'});
    let produtos = [], table, charts={};

    function normStatus(s){ if(!s) return 'Não informado'; s=s.toLowerCase(); if(s.includes('disponível')) return 'Disponível'; if(s.includes('indisponível')) return 'Indisponível'; if(s.includes('promo')) return 'Em Promoção'; if(s.includes('esgot')) return 'Esgotado'; return s.charAt(0).toUpperCase()+s.slice(1);}
    function definirCategoria(p){ const nome=(p.nome||'').toLowerCase(); if(nome.includes("camisa")||nome.includes("calça")||nome.includes("sapato")) return "Vestuário"; if(nome.includes("fone")||nome.includes("notebook")||nome.includes("celular")) return "Eletrônicos"; if(nome.includes("copo")||nome.includes("prato")||nome.includes("panela")) return "Utilidades Domésticas"; return "Outros";}

    async function load(){ try{ const res=await fetch(BASE_URL); const data=await res.json(); produtos=data.map(p=>{ const preco=+p.preco||0; const quantidade=+p.quantidade||0; const status=normStatus(p.status); return {...p,status,categoria:p.categoria||definirCategoria(p),preco,quantidade,valor:preco*quantidade};}); renderDashboard(); }catch(err){console.error(err); alert('Erro ao carregar produtos'); } }

    function getFiltered(){ const texto=document.getElementById('filtroTexto').value.toLowerCase(); const statusFiltro=document.getElementById('statusFiltro').value.toLowerCase(); return produtos.filter(p=>{ let ok=true; if(texto && !(p.nome.toLowerCase().includes(texto) || (p.categoria||'').toLowerCase().includes(texto))) ok=false; if(statusFiltro && p.status.toLowerCase()!==statusFiltro) ok=false; return ok; });}

    function renderDashboard(){ const filtered=getFiltered(); document.getElementById('kpiTotal').innerText=filtered.length; document.getElementById('kpiEstoque').innerText=filtered.reduce((a,p)=>a+p.quantidade,0); document.getElementById('kpiCategorias').innerText=new Set(filtered.map(p=>p.categoria)).size; document.getElementById('kpiValor').innerText=BRL.format(filtered.reduce((a,p)=>a+p.valor,0)); renderCharts(filtered); renderTable(filtered); }

    function destroyChart(name){ if(charts[name]){ charts[name].destroy(); delete charts[name]; } }

    function renderCharts(data){
    destroyChart('categoria'); const cat={}; data.forEach(p=>cat[p.categoria]=(cat[p.categoria]||0)+p.quantidade); charts['categoria']=new Chart(document.getElementById('chartCategoria'),{type:'pie', data:{labels:Object.keys(cat), datasets:[{data:Object.values(cat), backgroundColor:['#4f83ff','#f39c12','#2ecc71','#e74c3c','#9b59b6']}]}, options:{responsive:true}});

    destroyChart('status'); const status={}; data.forEach(p=>status[p.status]=(status[p.status]||0)+1); charts['status']=new Chart(document.getElementById('chartStatus'),{type:'doughnut', data:{labels:Object.keys(status), datasets:[{data:Object.values(status), backgroundColor:['#4f83ff','#f39c12','#2ecc71','#e74c3c','#9b59b6']}]}, options:{responsive:true}});

    destroyChart('topvalor'); const top=[...data].sort((a,b)=>b.valor-a.valor).slice(0,5); charts['topvalor']=new Chart(document.getElementById('chartTopValor'),{type:'bar', data:{labels:top.map(p=>p.nome), datasets:[{label:'Valor em estoque', data:top.map(p=>p.valor), backgroundColor:'#4f83ff'}]}, options:{responsive:true}});
    }

    function renderTable(data){ if(table){ table.clear().rows.add(data).draw(); } else { table=$('#tblProdutos').DataTable({ data:data, columns:[ {data:'nome'}, {data:'categoria'}, {data:'quantidade', render:q=>q<=5?`<span class="alert">${q}</span>`:q}, {data:'preco', render:p=>BRL.format(p)}, {data:'valor', render:v=>BRL.format(v)}, {data:'status'} ], dom:'Bfrtip', buttons:[ {extend:'csvHtml5', text:'Exportar CSV'}, {extend:'pdfHtml5', text:'Exportar PDF', orientation:'landscape', pageSize:'A4', exportOptions:{columns:':visible'}} ], pageLength:10, responsive:true, language:{ search:"Busca rápida:", lengthMenu:"Mostrar _MENU_ registros", info:"Mostrando _START_ a _END_ de _TOTAL_ produtos", paginate:{previous:"Anterior", next:"Próximo"}, zeroRecords:"Nenhum registro encontrado" } }); } }

    document.getElementById('btnRecarregar').addEventListener('click', load);
    document.getElementById('filtroTexto').addEventListener('input', renderDashboard);
    document.getElementById('statusFiltro').addEventListener('change', renderDashboard);
    document.addEventListener('DOMContentLoaded', load);
</script>
</body>
</html>
