<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Dashboard ‚Ä¢ Controle de Estoque</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        body{font-family:'Inter',sans-serif;background:#f4f6f9;margin:0;padding:0;}
        .container{max-width:1200px;margin:auto;padding:20px;}
        header{display:flex;flex-wrap:wrap;align-items:center;justify-content:space-between;margin-bottom:20px;}
        header h1{font-size:20px;margin:0;}
        .actions{display:flex;gap:8px;flex-wrap:wrap;}
        input,select,button{padding:6px 10px;border:1px solid #ccc;border-radius:6px;}
        button{background:#4f83ff;color:#fff;border:none;cursor:pointer;}
        button:hover{background:#3b6be0;}
        .grid.kpis{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:12px;margin-bottom:20px;}
        .kpi{background:#fff;padding:14px;border-radius:10px;box-shadow:0 2px 5px rgba(0,0,0,.08);text-align:center;}
        .kpi h2{margin:6px 0;font-size:20px;color:#4f83ff;}
        .row{display:flex;flex-wrap:wrap;gap:12px;}
        .card{background:#fff;padding:14px;border-radius:10px;box-shadow:0 2px 5px rgba(0,0,0,.08);flex:1;min-width:300px;}
        .chart-title{margin-bottom:6px;font-weight:500;}
        table{width:100%;border-collapse:collapse;margin-top:12px;}
        table th,table td{padding:8px;border:1px solid #ddd;text-align:left;}
        table th{background:#f1f3f6;}
        .alert{color:#e74c3c;font-weight:600;}
    </style>
</head>
<body>
<nav class="nav-links">
    <a href="Dashboard-relatorios-estoque.html">Dashboard</a>
    <a href="index.html">Movimenta√ß√µes</a>
    <a href="client-web-crud.html">Gerenciar Produtos</a>
    <a href="listagem.html">Listagem Simples</a>
</nav>

<style>
    .nav-links {
        display: flex;
        justify-content: center; /* centraliza os links */
        gap: 20px; /* espa√ßamento entre os links */
        padding: 15px 0;
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }

    .nav-links a {
        text-decoration: none;
        font-weight: 600;
        color: #4f83ff;
        padding: 8px 16px;
        border-radius: 8px;
        transition: all 0.3s ease; /* anima√ß√£o suave */
    }

    .nav-links a:hover {
        background-color: #4f83ff;
        color: white;
        transform: translateY(-2px); /* efeito leve de ‚Äúsubida‚Äù */
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
    }
</style>
<div class="container">
    <header>
        <h1>Dashboard ‚Ä¢ Controle de Estoque</h1>
        <div class="actions">
            <input id="filtroTexto" placeholder="Buscar por nome ou tipo" />
            <select id="statusFiltro">
                <option value="">Todos os status</option>
                <option>Dispon√≠vel</option>
                <option>Indispon√≠vel</option>
                <option>Esgotado</option>
                <option>Em Reposi√ß√£o</option>
                <option>Em Promo√ß√£o</option>
            </select>
            <input id="limiteBaixo" type="number" min="0" value="5" />
            <button id="btnRecarregar">Recarregar</button>
            <button id="btnExportarCSV">Exportar CSV</button>
            <button id="btnExportarPDF">Exportar PDF</button>
        </div>
    </header>

    <section class="grid kpis" id="kpis"></section>

    <div class="row">
        <div class="card">
            <div class="chart-title">Distribui√ß√£o de estoque por <b>tipo</b></div>
            <canvas id="chartPorTipo" height="220"></canvas>
        </div>
        <div class="card">
            <div class="chart-title">Produtos por <b>status</b></div>
            <canvas id="chartPorStatus" height="220"></canvas>
        </div>
    </div>

    <div class="row" style="margin-top:16px">
        <div class="card">
            <div class="chart-title">Top 5 por <b>valor em estoque</b></div>
            <canvas id="chartTopValor" height="220"></canvas>
        </div>
        <div class="card">
            <div class="chart-title">Evolu√ß√£o temporal das movimenta√ß√µes</div>
            <canvas id="chartEvolucao" height="220"></canvas>
        </div>
    </div>

    <div class="row" style="margin-top:16px">
        <div class="card" style="flex:1">
            <div class="chart-title">üìâ Produtos com baixo estoque</div>
            <table id="tblBaixoEstoque"></table>
        </div>
        <div class="card" style="flex:1">
            <div class="chart-title">üî• Produtos em promo√ß√£o</div>
            <table id="tblPromocoes"></table>
        </div>
        <div class="card" style="flex:1">
            <div class="chart-title">‚ùå Produtos esgotados</div>
            <table id="tblEsgotados"></table>
        </div>
    </div>
</div>

<script>
    const BASE_URL = 'http://localhost:8080/produtos';
    const MOV_URL = 'http://localhost:8080/movimentacoes';
    const BRL = new Intl.NumberFormat('pt-BR',{style:'currency',currency:'BRL'});
    let produtos = [];
    let charts = {};

    // Destr√≥i gr√°fico antigo
    function destroyChart(name){
      if(charts[name]){
        charts[name].destroy();
        delete charts[name];
      }
    }

    // Normaliza status
    function normStatus(s){
      if(!s) return 'N√£o informado';
      return s.charAt(0).toUpperCase() + s.slice(1).toLowerCase();
    }

    // Carrega produtos do back-end
    async function load(){
      try{
        const res = await fetch(BASE_URL);
        const data = await res.json();

        produtos = data.map(p => ({
          ...p,
          status: normStatus(p.status),
          categoria: p.categoria || 'N√£o informado',
          preco: +p.preco || 0,
          quantidade: +p.quantidade || 0,
          valor: (+p.preco || 0) * (+p.quantidade || 0)
        }));

        render();
        loadMovimentacoes();
      } catch(err){
        console.error(err);
        alert('Erro ao carregar produtos');
      }
    }

    // Carrega movimenta√ß√µes para evolu√ß√£o temporal
    async function loadMovimentacoes(){
      try{
        const res = await fetch(MOV_URL);
        const movs = await res.json();
        drawEvolucao(movs);
      } catch(err){
        console.error(err);
      }
    }

    // Filtra produtos pelo input e status
    function getFiltered(){
  const texto = document.getElementById('filtroTexto').value.toLowerCase();
  const statusFiltro = document.getElementById('statusFiltro').value.toLowerCase(); // <--- normalize
  return produtos.filter(p => {
    let ok = true;

    // filtro por texto
    if(texto && !(p.nome.toLowerCase().includes(texto) || (p.categoria || '').toLowerCase().includes(texto))){
      ok = false;
    }

    // filtro por status
    if(statusFiltro && p.status.toLowerCase() !== statusFiltro){ // <--- normalize
      ok = false;
    }

    return ok;
  });
}


    // Renderiza todos os gr√°ficos e tabelas
    function render(){
      drawKPIs();
      drawPorTipo();
      drawPorStatus();
      drawTopValor();
      drawTables();
    }

    // KPIs
    function drawKPIs(){
      const lista = getFiltered();
      const totalProdutos = lista.length;
      const totalEstoque = lista.reduce((a,p)=>a+p.quantidade,0);
      const categorias = new Set(lista.map(p=>p.categoria)).size;
      const valorTotal = lista.reduce((a,p)=>a+p.valor,0);

      document.getElementById('kpis').innerHTML = `
        <div class="kpi"><p>Total Produtos</p><h2>${totalProdutos}</h2></div>
        <div class="kpi"><p>Total em Estoque</p><h2>${totalEstoque}</h2></div>
        <div class="kpi"><p>Categorias</p><h2>${categorias}</h2></div>
        <div class="kpi"><p>Valor Total</p><h2>${BRL.format(valorTotal)}</h2></div>`;
    }

    // Gr√°fico por tipo
    function drawPorTipo(){
      destroyChart('tipo');
      const lista = getFiltered();
      const agrup = {};
      lista.forEach(p => {
        agrup[p.categoria] = (agrup[p.categoria] || 0) + p.quantidade;
      });
      const ctx = document.getElementById('chartPorTipo');
      charts['tipo'] = new Chart(ctx, {
        type: 'pie',
        data: { labels: Object.keys(agrup), datasets: [{ data: Object.values(agrup) }] },
        options: { responsive: true }
      });
    }

    // Gr√°fico por status
    function drawPorStatus(){
      destroyChart('status');
      const lista = getFiltered();
      const agrup = {};
      lista.forEach(p => { agrup[p.status] = (agrup[p.status]||0) + 1; });
      const ctx = document.getElementById('chartPorStatus');
      charts['status'] = new Chart(ctx, {
        type: 'doughnut',
        data: { labels: Object.keys(agrup), datasets: [{ data: Object.values(agrup) }] },
        options: { responsive: true }
      });
    }

    // Top 5 por valor em estoque
    function drawTopValor(){
      destroyChart('topvalor');
      const lista = getFiltered();
      const top = [...lista].sort((a,b)=>b.valor-a.valor).slice(0,5);
      const ctx = document.getElementById('chartTopValor');
      charts['topvalor'] = new Chart(ctx, {
        type: 'bar',
        data: { labels: top.map(p=>p.nome), datasets:[{label:'Valor em estoque', data:top.map(p=>p.valor), backgroundColor:'#4f83ff'}] },
        options: { responsive: true }
      });
    }

    // Evolu√ß√£o temporal das movimenta√ß√µes
    function drawEvolucao(movs){
      destroyChart('evolucao');
      const porDia = {};
      movs.forEach(m => {
        const d = new Date(m.data);
        const dia = d.toLocaleDateString('pt-BR');
        const qtd = m.tipo.toLowerCase().includes('sa√≠da') ? -m.quantidade : m.quantidade;
        porDia[dia] = (porDia[dia] || 0) + qtd;
      });
      const labels = Object.keys(porDia).sort((a,b)=>{
        const pa=a.split('/').reverse().join('-');
        const pb=b.split('/').reverse().join('-');
        return new Date(pa) - new Date(pb);
      });
      let total=0;
      const values = labels.map(l => { total += porDia[l]; return total; });
      const ctx = document.getElementById('chartEvolucao');
      charts['evolucao'] = new Chart(ctx, {
        type:'line',
        data:{ labels, datasets:[{ label:'Estoque acumulado', data:values, borderColor:'#4f83ff', fill:false }] },
        options:{ responsive:true, tension:0.3 }
      });
    }

    // Preenche tabelas de baixo estoque, promo√ß√µes e esgotados
    function drawTables(){
      const lista = getFiltered();
      const limite = Number(document.getElementById('limiteBaixo').value) || 5;
      const baixo = lista.filter(p => p.quantidade <= limite);
      const promo = lista.filter(p => p.status.toLowerCase() === 'em promo√ß√£o');
      const esgotados = lista.filter(p => p.status.toLowerCase() === 'esgotado' || p.quantidade === 0);

      function buildTable(arr){
        if(arr.length===0) return '<tr><td colspan="3">Nenhum</td></tr>';
        return '<tr><th>Produto</th><th>Qtd</th><th>Valor</th></tr>' +
          arr.map(p => `<tr><td>${p.nome}</td><td class="${p.quantidade<=limite?'alert':''}">${p.quantidade}</td><td>${BRL.format(p.valor)}</td></tr>`).join('');
      }

      document.getElementById('tblBaixoEstoque').innerHTML = buildTable(baixo);
      document.getElementById('tblPromocoes').innerHTML = buildTable(promo, true);
      document.getElementById('tblEsgotados').innerHTML = buildTable(esgotados);
    }

    // Export CSV
    function exportarCSV(){
      const lista = getFiltered();
      let csv = "Nome;Categoria;Quantidade;Pre√ßo;Valor;Status\n";
      lista.forEach(p => {
        csv += `${p.nome};${p.categoria};${p.quantidade};${p.preco};${p.valor};${p.status}\n`;
      });
      const blob = new Blob([csv], { type: "text/csv;charset=utf-8;" });
      const link = document.createElement("a");
      link.href = URL.createObjectURL(blob);
      link.download = "estoque.csv";
      link.click();
    }

    // Export PDF
    function exportarPDF(){
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();
      doc.setFontSize(14);
      doc.text("Relat√≥rio de Estoque", 10, 10);
      let y = 20;
      getFiltered().forEach(p => {
        doc.text(`${p.nome} | Qtd: ${p.quantidade} | ${BRL.format(p.valor)} | ${p.status}`, 10, y);
        y += 8;
        if(y > 280){ doc.addPage(); y=20; }
      });
      doc.save("estoque.pdf");
    }

    // Eventos
    document.getElementById('btnRecarregar').addEventListener('click', load);
    document.getElementById('btnExportarCSV').addEventListener('click', exportarCSV);
    document.getElementById('btnExportarPDF').addEventListener('click', exportarPDF);
    document.getElementById('filtroTexto').addEventListener('input', render);
    document.getElementById('statusFiltro').addEventListener('change', render);
    document.getElementById('limiteBaixo').addEventListener('input', render);

    document.addEventListener('DOMContentLoaded', load);
</script>
</body>
</html>
